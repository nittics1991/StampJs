<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8"> 

<title>StmpJs</title>

<style>

.font_family {
    display:none;
}

#main {
    position:relative;
}

canvas {
	border:1px ridge #0000ff;
}

table {
	border-collapse:collapse;
}

.setting_area th,td {
	border: 1px ridge #cfcfcf;
}

ul {
    padding:0;
    list-style-type:none;
}

.button_flex {
    display:flex;
    align-items:center;
}

footer {
    height:40px;
}

.stamp_dialog {
    border:2px ridge #000000;
    display:none;
    z-index:10;
    position:absolute;
    left:40%;
    top:20%;
    background-color:#ffffff;
}

.stamp_dialog > div:first-child {
    background-color:#c0c0c0;
}

.stamp_dialog > div:last-child {
    display:flex;
    justify-content:center
}

#file_dialog {
    width:300px;
}

#date_dialog {
    width:250px;
}

input[type="date"] {
    height:1rem;
}

input:invalid {
    border-color:red;
}

</style>

</head>
<body>

<div id="main">
<div id="frame1" class="frame">
	<h4>スタンプ StampJs</h4>
	<div class="stamp_area">
		<div class="stamp_image"></div>
	</div>
	<div class="setting_area">
        <ul class="stamp_buttons button_flex">
            <li>
                <select name="stamp_select">
                    <option value=""></option>
                    <option value="dateStamp">日付印</option>
                    <option value="signetStamp">認印</option>
                    <option value="squareStamp">角印</option>
                    <option value="companyStamp">社印</option>
                    <option value="freeStamp1">自由1</option>
                    <option value="freeStamp2">自由2</option>
                    <option value="freeStamp3">自由3</option>
                    <option value="freeStamp4">自由4</option>
                    <option value="freeStamp5">自由5</option>
                </select>
            </li>
            
            <li><button type="button" name="refresh_button">更新</button></li>
            <li><button type="button" name="load_button">読込</button></li>
            <li><button type="button" name="save_button">保存</button></li>
            <li><button type="button" name="remove_button">削除</button></li>
            <li><button type="button" name="upload_button">アップロード</button></li>
            <li><button type="button" name="download_button">ダウンロード</button></li>
            <li><button type="button" name="date_button">日付選択</button></li>
        </ul>
        
        <ul class="finger_buttons button_flex">
            <li><button type="button" name="finget_setting_button">指紋設定/履歴</button></li>
            <li><label><input type="radio" name="finger_stamp[]" value="false" checked></inpit>無</label></li>
            <li><label><input type="radio" name="finger_stamp[]" value="true"></inpit>有</label></li>
        </ul>
        
		<table class="setting_full">
			<thead>
				<tr>
					<th></th>
					<th>全体</th>
				</tr>
			</thead>
			<tbody>
                <tr class="stamp_type">
					<th>種別</th>
					<td>
						<label><input type="radio" name="stamp_type[]" value="circle"></inpit>丸印</label>
						<label><input type="radio" name="stamp_type[]" value="rect"></inpit>角印</label>
                    </td>
				</tr>
				
                <tr class="stamp_width">
					<th>全体幅</th>
					<td>
						<input type="number" name="stamp_width" value=""></inpit>
					</td>
				</tr>
				
				<tr class="stamp_height">
					<th>全体高</th>
					<td>
						<input type="number" name="stamp_height" value=""></inpit>
					</td>
				</tr>
				
				<tr class="line_weight">
					<th>線幅</th>
					<td>
						<input type="number" name="line_weight" value=""></inpit>
					</td>
				</tr>
				
				<tr class="stamp_color">
					<th>印影色</th>
					<td>
						<label><input type="radio" name="stamp_color[]" value="red"></inpit>赤</label>
						<label><input type="radio" name="stamp_color[]" value="black"></inpit>黒</label>
					</td>
				</tr>
				
				<tr class="border_direction">
					<th>仕切線</th>
					<td>
						<label><input type="radio" name="border_direction[]" value="N"></inpit>無</label>
						<label><input type="radio" name="border_direction[]" value="H"></inpit>水平</label>
						<label><input type="radio" name="border_direction[]" value="V"></inpit>垂直</label>
					</td>
				</tr>
				
				<tr class="text_direction">
					<th>文字方向</th>
					<td>
						<label><input type="radio" name="text_direction[]" value="H"></inpit>水平</label>
						<label><input type="radio" name="text_direction[]" value="V"></inpit>垂直</label>
					</td>
				</tr>
				
				<tr class="text_placement">
					<th>文字配置方向</th>
					<td>
						<label><input type="radio" name="text_placement[]" value="H"></inpit>水平</label>
						<label><input type="radio" name="text_placement[]" value="V"></inpit>垂直</label>
					</td>
				</tr>
                
				<tr class="option_position">
					<th>追加情報</th>
					<td>
						<label><input type="radio" name="option_position[]" value="non"></inpit>無</label>
						<label><input type="radio" name="option_position[]" value="left"></inpit>左</label>
						<label><input type="radio" name="option_position[]" value="right"></inpit>右</label>
						<label><input type="radio" name="option_position[]" value="top"></inpit>上</label>
						<label><input type="radio" name="option_position[]" value="bottom"></inpit>下</label>
					</td>
				</tr>
			</tbody>
		</table>
		
		<table class="setting_parts">
			<thead>
				<tr>
					<th></th>
					<th>1番</th>
					<th>2番</th>
					<th>3番</th>
					<th>4番</th>
				</tr>
			</thead>
			<tbody>
				<tr>
					<th></th>
					<th><button type="button" name="clear1">クリア</button></th>
					<th><button type="button" name="clear2">クリア</button></th>
					<th><button type="button" name="clear3">クリア</button></th>
					<th><button type="button" name="clear4">クリア</button></th>
				</tr>
                
				<tr class="stamp_text">
					<th>表示文字</th>
					<td>
						<input type="text" name="stamp_text[1]"></inpit>
					</td>
					<td>
						<input type="text" name="stamp_text[2]"></inpit>
					</td>
					<td>
						<input type="text" name="stamp_text[3]"></inpit>
					</td>
					<td>
						<input type="text" name="stamp_text[4]"></inpit>
					</td>
				</tr>
				
				<tr class="font_family">
					<th>フォント</th>
					<td>
						<select name="font_family[1]"></select>
					</td>
					<td>
						<select name="font_family[2]"></select>
					</td>
					<td>
						<select name="font_family[3]"></select>
					</td>
					<td>
						<select name="font_family[4]"></select>
					</td>
				</tr>
				
				<tr class="font_size">
					<th>サイズ</th>
					<td>
						<input type="number" name="font_size[1]" value=""></inpit>
					</td>
					<td>
						<input type="number" name="font_size[2]" value=""></inpit>
					</td>
					<td>
						<input type="number" name="font_size[3]" value=""></inpit>
					</td>
					<td>
						<input type="number" name="font_size[4]" value=""></inpit>
					</td>
				</tr>
				
				<tr class="text_align">
					<th>横配置</th>
					<td>
						<select name="text_align[1]">
                            <option value=""></option>
							<option value="left">左</option>
							<option value="center">中央</option>
							<option value="right">右</option>
						</select>
					</td>
					<td>
						<select name="text_align[2]">
                            <option value=""></option>
							<option value="left">左</option>
							<option value="center">中央</option>
							<option value="right">右</option>
						</select>
					</td>
					<td>
						<select name="text_align[3]">
                            <option value=""></option>
							<option value="left">左</option>
							<option value="center">中央</option>
							<option value="right">右</option>
						</select>
					</td>
					<td>
						<select name="text_align[4]">
                            <option value=""></option>
							<option value="left">左</option>
							<option value="center">中央</option>
							<option value="right">右</option>
						</select>
					</td>
				</tr>
				
				<tr class="vertical_align">
					<th>縦配置</th>
					<td>
						<select name="vertical_align[1]">
                            <option value=""></option>
							<option value="top">上</option>
							<option value="middle">中央</option>
							<option value="bottom">下</option>
						</select>
					</td>
					<td>
						<select name="vertical_align[2]">
                            <option value=""></option>
							<option value="top">上</option>
							<option value="middle">中央</option>
							<option value="bottom">下</option>
						</select>
					</td>
					<td>
						<select name="vertical_align[3]">
                            <option value=""></option>
							<option value="top">上</option>
							<option value="middle">中央</option>
							<option value="bottom">下</option>
						</select>
					</td>
					<td>
						<select name="vertical_align[4]">
                            <option value=""></option>
							<option value="top">上</option>
							<option value="middle">中央</option>
							<option value="bottom">下</option>
						</select>
					</td>
				</tr>
				
				<tr class="margin_size">
					<th>マージン</th>
					<td>
						<input type="number" name="margin_size[1]" value=""></inpit>
					</td>
					<td>
						<input type="number" name="margin_size[2]" value=""></inpit>
					</td>
					<td>
						<input type="number" name="margin_size[3]" value=""></inpit>
					</td>
					<td>
						<input type="number" name="margin_size[4]" value=""></inpit>
					</td>
				</tr>
				
			</tbody>
		</table>
	</div>
</div>
          
<div id="file_dialog" class="stamp_dialog" draggable="true">
    <div>ファイル選択</div>
    <input type="file" name="file_name">
    <input type="hidden" name="id">
    <div><button type="button" name="close_button">閉じる</button></div>
</div>

<div id="date_dialog" class="stamp_dialog" draggable="true">
    <div>日付入力</div>
    <div><label>日付<input type="date" name="date_input" required></label></div>
    <div><label>書式<input type="text" name="date_format" value="YYYY-MM-DD" required title="@see Momentjs"></label></div>
    <div>
        <label><input type="radio" name="date_target[]" value="1"></inpit>1番</label>
        <label><input type="radio" name="date_target[]" value="2" checked></inpit>2番</label>
        <label><input type="radio" name="date_target[]" value="3"></inpit>3番</label>
        <label><input type="radio" name="date_target[]" value="4"></inpit>4番</label>
    </div>
    <input type="hidden" name="id">
    <div>
        <button type="button" name="exec_button">設定</button>
        <button type="button" name="close_button">閉じる</button>
    </div>
</div>

</div>

<footer></footer>

<script src="../lib/momentjs.js"></script>

<script src="../src/StampFactory.js"></script>
<script src="../src/StampBuilder.js"></script>

<script src="../src/StampFrame.js"></script>
<script src="../src/StampData.js"></script>

<script src="../src/HorizonText.js"></script>
<script src="../src/VerticalText.js"></script>

<script src="../src/CircleHorizonBorder.js"></script>
<script src="../src/CircleVerticalBorder.js"></script>

<script src="../src/RectHorizonBorder.js"></script>
<script src="../src/RectVerticalBorder.js"></script>

<script src="../src/HorizonPlacement.js"></script>
<script src="../src/VerticalPlacement.js"></script>

<script src="../src/OptionPosition.js"></script>

<script src="../src/RectStamp.js"></script>
<script src="../src/CircleStamp.js"></script>

<script src="../src/Shapes.js"></script>
<script src="../src/StampJs.js"></script>
 
<script src="../src/CanvasRender.js"></script>

<script src="../src/helper/StampCanvasExchanger.js"></script>
<script src="../src/helper/StampFileDownloader.js"></script>
<script src="../src/helper/StampTableHelper.js"></script>

<script src="../src/helper/StampJsView.js"></script>
<script src="../src/helper/StampFingerPrint.js"></script>

<script>

var inidata = {
	stamp_select:'dateStamp',
	frame:{
		stamp_type:'circle',
		stamp_width:200,
		stamp_height:200,
		line_weight:3,
		stamp_color:'red',
		border_direction:'H',
		text_placement:'V',
		text_direction:'H',
		option_position:'bottom',
	},
	data:[
		{
			stamp_text:'(営業1)M',
			font_family:'',
			font_size:30,
			text_align:'center',
			vertical_align:'bottom',
			margin_size:0,
		},
		{
			stamp_text:moment().format('YYYY-MM-DD'),
			font_family:'',
			font_size:30,
			text_align:'center',
			vertical_align:'middle',
			margin_size:0,
		},
		{
			stamp_text:'青木 太郎',
			font_family:null,
			font_size:30,
			text_align:'center',
			vertical_align:'top',
			margin_size:5,
		},
		{
			stamp_text:'代',
			font_family:null,
			font_size:30,
			text_align:'right',
			vertical_align:'bottom',
			margin_size:0,
		},
	],
};

//load
window.addEventListener('load', function() {
    StampJsView.dataToFrom('#frame1', inidata);
    document.querySelector('#frame1 button[name="refresh_button"]').click();
    
    let date_format = document.querySelector(
        '#date_dialog [name="date_format"]'
    ).value;
    
    document.querySelector(
        '#date_dialog [name="date_input"]'
    ).value = moment().format(date_format);
});

//main button
document.querySelector('#frame1 button[name="refresh_button"]')
    .addEventListener('click', function(e) {
	
    StampJsView.clearImage('#frame1');
    
    let data = StampJsView.formToData('#frame1');
    let factory = new StampFactory();
	let builder = factory.builder();
	let stamp;
    
    switch (data.stamp_select) {
        case 'dateStamp':
            data.frame.stamp_height = data.frame.stamp_width;
            stamp = builder.dateStamp('#frame1 .stamp_image', data);
            break;
        case 'signetStamp':
            data.frame.stamp_height = data.frame.stamp_width;
            stamp = builder.signetStamp('#frame1 .stamp_image', data);
            break;
        case 'squareStamp':
            stamp = builder.squareStamp('#frame1 .stamp_image', data);
            break;
        case 'companyStamp':
            stamp = builder.companyStamp('#frame1 .stamp_image', data);
            break;
        case '':
            return;
        default:
            if (data.frame.stamp_type == 'circle') {
                data.frame.stamp_height = data.frame.stamp_width;
            }
            stamp = new StampJs('#frame1 .stamp_image', data);
            break;
    }
	stamp.render();
    
    if (document.querySelector(
        '#frame1 [name="finger_stamp[]"]:checked'
        ).value == 'true'
     ) {
        let stamp_select = document.querySelector(
            '#frame1 .stamp_select'
        ).value;
        
        //設定を読み込んでスタンプ 
        
        let fingerPrint = new StampFingerPrint('#frame1', 'frame1');
        fingerPrint.stamp(1, 1, '#ffffff');
    }
    
    let imgUri = StampCanvasExchanger.exchangeToImage('#frame1 canvas');
});

document.querySelector('#frame1 button[name="load_button"]')
    .addEventListener('click', function(e) {
    
    let select = document.querySelector(
        '#frame1 [name="stamp_select"]'
    );
    
    if (!window.confirm('May I load ?')) return;
    let json = StampJsView.load('frame1', select.value);
    
    if (json == null) return;
    
    data = JSON.parse(json);
    StampJsView.dataToFrom('#frame1', data);
    document.querySelector('#frame1 button[name="refresh_button"]').click();
});

document.querySelector('#frame1 button[name="save_button"]')
    .addEventListener('click', function(e) {
    
    if (!window.confirm('May I save ?')) return;
    let data = StampJsView.formToData('#frame1');
    StampJsView.save('frame1', data);
});

document.querySelector('#frame1 button[name="remove_button"]')
    .addEventListener('click', function(e) {
    
    if (!window.confirm('May I remove ?')) return;
    let data = StampJsView.formToData('#frame1');
    StampJsView.remove('frame1', data);
});

document.querySelector('#frame1 button[name="upload_button"]')
    .addEventListener('click', function(e) {
    
    document.querySelector('#file_dialog input[name="id"]')
        .value = '#frame1';
    
    document.querySelector('#file_dialog')
        .style.display = "block";
});

document.querySelector('#frame1 button[name="download_button')
    .addEventListener('click', function(e) {
    
    StampJsView.download('frame1', '#frame1');
});

document.querySelector('#frame1 button[name="date_button"]')
    .addEventListener('click', function(e) {
    
    document.querySelector('#date_dialog')
        .style.display = "block";
});

//clear button
document.querySelector('#frame1 button[name="clear1"]')
    .addEventListener('click', function(e) {
    
    StampJsView.clearFormFor('#frame1', 1);
});

document.querySelector('#frame1 button[name="clear2"]')
    .addEventListener('click', function(e) {
    
    StampJsView.clearFormFor('#frame1', 2);
});

document.querySelector('#frame1 button[name="clear3"]')
    .addEventListener('click', function(e) {
    
    StampJsView.clearFormFor('#frame1', 3);
});

document.querySelector('#frame1 button[name="clear4"]')
    .addEventListener('click', function(e) {
    
    StampJsView.clearFormFor('#frame1', 4);
});

//stamp_select
document.querySelector('#frame1 [name="stamp_select"]')
    .addEventListener('change', function(e) {
    
    switch (e.target.value) {
        case 'dateStamp':
            StampJsView.disableTo('#frame1', []);
            StampJsView.hiddenInStandard('#frame1', e.target.value);
            break;
        case 'signetStamp':
            StampJsView.disableTo('#frame1', [2,3,4]);
            StampJsView.hiddenInStandard('#frame1', e.target.value);
            break;
        case 'squareStamp':
        case 'companyStamp':
            StampJsView.disableTo('#frame1', [4]);
            StampJsView.hiddenInStandard('#frame1', e.target.value);
            break;
        default:
            StampJsView.disableTo('#frame1', []);
            StampJsView.visibleInStandard('#frame1', e.target.value);
            break;
    }
});

//dialog
Array.prototype.forEach.call(
    document.querySelectorAll('button[name="close_button"]'),
    function(elm) {
        elm.addEventListener('click', function(e) {
            e.target.parentNode.parentNode.style.display = "none";
        });
    }
);

Array.prototype.forEach.call(
    document.querySelectorAll('.stamp_dialog'),
    function(elm) {
        elm.addEventListener('dragstart', function(e) {
            e.dataTransfer.setData(
                "text/plain",
                '#' + elm.id
            );
            e.stopPropagation();
        });
    }
);

document.querySelector('#main')
    .addEventListener('dragover', function(e) {
    
    e.preventDefault();
});

document.querySelector('#main')
    .addEventListener('dragenter', function(e) {
    
    e.preventDefault();
});

document.querySelector('#main')
    .addEventListener('drop', function(e) {
    
    e.preventDefault();
    e.stopPropagation();
    
    let target = document.querySelector(
        e.dataTransfer.getData('text/plain')
    );
    
    target.style.top = e.clientY + 'px';
    target.style.left = e.clientX + 'px';
});

//file dialog
document.querySelector('#file_dialog [name="file_name"]')
    .addEventListener('change', function(e) {
    
    document.querySelector('#file_dialog')
        .style.display = "none";
    
    let reader = new FileReader();
    let files = e.target.files;
    reader.readAsText(files[0]);
    
    reader.addEventListener('load', function(e) {
        let dataset = JSON.parse(reader.result);
        
        if (dataset == null ||
            dataset == [] ||
            !Array.isArray(dataset)
        ) return;
        
        let selector = document.querySelector(
            '#file_dialog [name="id"]'
        ).value;
        
        dataset.forEach(function(json) {
            let data = JSON.parse(json)
            StampJsView.save('frame1', data);
        });
        
        StampJsView.clearForm('#frame1');
    });
});

//date dialog
document.querySelector('#date_dialog button[name="exec_button"]')
    .addEventListener('click', function(e) {
    
    document.querySelector('#date_dialog')
        .style.display = "none";
    
    let date_input = document.querySelector(
        '#date_dialog [name="date_input"]'
    ).value;
    
    let date_format = document.querySelector(
        '#date_dialog [name="date_format"]'
    ).value;
    
    let date_target = document.querySelector(
        '#date_dialog [name="date_target[]"]:checked'
    ).value;
    
    let str = moment(date_input).format(date_format);
    
    document.querySelector(
        '#frame1 [name="stamp_text[' + date_target + ']"]'
    ).value = str;
});

//finger button
document.querySelector('#frame1 button[name="finget_setting_button"]')
    .addEventListener('click', function(e) {
    
    let stamp_select = document.querySelector(
        '#frame1 [name="stamp_select"]'
    );
    
    window.open(
        'StampFingerPrint.htm?stamp_select=' + stamp_select.value
            + '&stamp_name='
            + stamp_select.options[stamp_select.selectedIndex].text
    );
});

</script>
	
</body>
</html>
